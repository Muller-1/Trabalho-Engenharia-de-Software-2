<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Painel do Administrador</title>
    <style>
        * {  margin: 0;  padding: 0;  box-sizing: border-box;  font-family: 'Segoe UI', Arial, sans-serif;}
        body { font-family: sans-serif; background-color: #f4f7f6; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-bottom: 2px solid #ccc; padding-bottom: 15px; }
        h1 { color: #007bff; }
        .controls button { background-color: #28a745; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; margin-left: 10px; }
        .controls button:hover { background-color: #1e7e34; }
        .logout-btn { background-color: #dc3545 !important; }
        .painel {padding: 20px}
        .reset-btn { background-color: #ffc107; color: #333; }
        .reset-btn:hover { background-color: #e0a800; }

        /* Estilos do Modal */
        .modal { display: none; position: fixed; z-index: 1; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
        .modal-content { background-color: #fff; margin: 10% auto; padding: 25px; border-radius: 8px; width: 90%; max-width: 400px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .close-btn { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close-btn:hover { color: #000; }
        input[type="text"], input[type="password"] { width: 100%; padding: 10px; margin: 8px 0 15px 0; display: inline-block; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .modal-footer { margin-top: 15px; text-align: right; }
        .register-message { color: green; margin-top: 10px; }
        .message-error { color: red; margin-top: 10px; }

        nav { background: #111; color: white; display: flex; justify-content: space-between; align-items: center; padding: 1rem 2rem; position: sticky; top: 0; z-index: 1000;  }
        nav .logo {        font-size: 1.5rem;        font-weight: bold;        color: #f1c40f;        }
        nav ul {        list-style: none;        display: flex;        gap: 1rem;        }
        nav ul li a {        color: white;        text-decoration: none;        transition: color 0.3s;        }
        nav ul li a:hover {     color: #f1c40f;        }
    </style>
</head>
<body>
    <div id="navbar"></div>

    <div class="painel">
        <h1>Painel Administrativo</h1>
        <div class="controls">
            <button id="show-register-modal-btn">Criar Nova Conta</button>
            <button id="show-password-modal-btn" class="reset-btn">Alterar Senha</button>
            <button class="logout-btn" onclick="logout()">Sair</button>
        </div>
        <p>Bem-vindo, Administrador. Aqui você pode gerenciar usuários e eventos.</p>
        <p>Seus links de gerenciamento de eventos ou usuários estariam aqui.</p>
    </div>

    <!-- Modal de Cadastro de Novo Usuário -->
    <div id="register-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" id="close-register-modal">&times;</span>
            <h2>Criar Novo Usuário</h2>
            <form id="new-user-form">
                <label for="reg-username">Nome de Usuário:</label>
                <input type="text" id="reg-username" required>

                <label for="reg-password">Senha:</label>
                <input type="password" id="reg-password" required>
                
                <div class="modal-footer">
                    <button type="submit">Registrar</button>
                </div>
                <p id="reg-message" class="register-message"></p>
            </form>
        </div>
    </div>

    <!-- Modal de Alteração de Senha -->
    <div id="password-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" id="close-password-modal">&times;</span>
            <h2>Alterar Senha de Usuário</h2>
            <form id="change-password-form">
                <label for="target-username">Usuário Alvo:</label>
                <input type="text" id="target-username" placeholder="Ex: admin ou usuario_teste" required>

                <label for="new-password">Nova Senha:</label>
                <input type="password" id="new-password" required>
                
                <div class="modal-footer">
                    <button type="submit" class="reset-btn" style="color: black;">Alterar Senha</button>
                </div>
                <p id="pass-message" class="register-message"></p>
            </form>
        </div>
    </div>

    <script>
        fetch('navbar.html')
          .then(response => response.text())
          .then(data => {
            document.getElementById('navbar').innerHTML = data;
          })
          .catch(err => console.error('Erro ao carregar o navbar:', err));
    </script>
    <script>
        const registerModal = document.getElementById('register-modal');
        const showModalBtn = document.getElementById('show-register-modal-btn');
        const closeModalBtn = document.getElementById('close-register-modal');
        const newUserForm = document.getElementById('new-user-form');
        const regMessageEl = document.getElementById('reg-message');

        const passwordModal = document.getElementById('password-modal');
        const showPasswordModalBtn = document.getElementById('show-password-modal-btn');
        const closePasswordModalBtn = document.getElementById('close-password-modal');
        const changePasswordForm = document.getElementById('change-password-form');
        const passMessageEl = document.getElementById('pass-message');
        
        // Abertura e Fechamento do Modal de Cadastro
        showModalBtn.onclick = function() {
            registerModal.style.display = 'block';
            regMessageEl.textContent = '';
            newUserForm.reset();
        }

        closeModalBtn.onclick = function() {
            registerModal.style.display = 'none';
        }

        // Abertura e Fechamento do Modal de Senha
        showPasswordModalBtn.onclick = function() {
            passwordModal.style.display = 'block';
            passMessageEl.textContent = '';
            changePasswordForm.reset();
        }

        closePasswordModalBtn.onclick = function() {
            passwordModal.style.display = 'none';
        }

        window.onclick = function(event) {
            if (event.target == registerModal) {
                registerModal.style.display = 'none';
            }
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('role');
            window.location.href = '/';
        }

        newUserForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const username = document.getElementById('reg-username').value;
            const password = document.getElementById('reg-password').value;
            const token = localStorage.getItem('token');
            
            regMessageEl.textContent = 'Registrando...';

            try {
                const response = await fetch('http://localhost:3000/api/register', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'x-access-token': token
                    },
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();

                if (response.ok) { // Status 201
                    regMessageEl.textContent = 'Sucesso: ' + data.message;
                    newUserForm.reset();
                } else if (response.status === 403) {
                     regMessageEl.style.color = 'red';
                     regMessageEl.textContent = 'Acesso Negado. Você não é um administrador válido.';
                } else {
                    regMessageEl.style.color = 'red';
                    regMessageEl.textContent = 'Erro ao criar conta: ' + data.message;
                }
            } catch (error) {
                regMessageEl.style.color = 'red';
                regMessageEl.textContent = 'Erro ao conectar com o servidor.';
            }
        });

        changePasswordForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const targetUsername = document.getElementById('target-username').value;
            const newPassword = document.getElementById('new-password').value;
            const token = localStorage.getItem('token');

            passMessageEl.textContent = 'Alterando senha...';
            passMessageEl.style.color = 'initial';

            try {
                const response = await fetch('http://localhost:3000/api/change-password', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-access-token': token // Protegido pelo token de admin
                    },
                    body: JSON.stringify({ targetUsername, newPassword })
                });

                const data = await response.json();

                if (response.ok) {
                    passMessageEl.style.color = 'green';
                    passMessageEl.textContent = 'Sucesso: ' + data.message;
                    changePasswordForm.reset();
                } else {
                    passMessageEl.style.color = 'red';
                    passMessageEl.textContent = 'Erro: ' + (data.message || response.statusText);
                }
            } catch (error) {
                passMessageEl.style.color = 'red';
                passMessageEl.textContent = 'Erro ao comunicar com o servidor.';
            }
        });
        
        // Se o usuário acessar esta página sem estar logado, redireciona.
        window.onload = () => {
             if (localStorage.getItem('role') !== 'admin') {
                window.location.href = '/'; 
            }
        }
    </script>
</body>
</html>
